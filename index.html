<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lindy AI Chat con Memoria</title>
    <style>
        /* El CSS es el mismo que en la versi√≥n anterior: completo y funcional */
        :root{--bg-color-light:#f0f2f5;--chat-bg-light:#fff;--text-color-light:#050505;--input-bg-light:#f0f2f5;--user-bubble-light:#0084ff;--bot-bubble-light:#e4e6eb;--text-user-light:#fff;--text-bot-light:#050505;--header-bg-light:#fff;--border-color-light:#ced0d4;--debug-bg-light:#fafafa;--bg-color-dark:#121212;--chat-bg-dark:#1e1e1e;--text-color-dark:#e4e6eb;--input-bg-dark:#3a3b3c;--user-bubble-dark:#0084ff;--bot-bubble-dark:#3a3b3c;--text-user-dark:#fff;--text-bot-dark:#e4e6eb;--header-bg-dark:#242526;--border-color-dark:#3a3b3c;--debug-bg-dark:#2d2d2d}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;margin:0;display:flex;justify-content:center;align-items:center;height:100vh;background:var(--bg-color-light);transition:background-color .3s ease}body.dark-theme{background:var(--bg-color-dark)}#chat-container{width:100%;height:100%;max-width:800px;max-height:95vh;display:flex;flex-direction:column;background:var(--chat-bg-light);border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.1);overflow:hidden;transition:background-color .3s ease;position:relative;z-index:10}body.dark-theme #chat-container{background:var(--chat-bg-dark)}.chat-header{padding:10px 20px;display:flex;justify-content:space-between;align-items:center;background:var(--header-bg-light);border-bottom:1px solid var(--border-color-light);transition:background-color .3s ease,border-color .3s ease}body.dark-theme .chat-header{background:var(--header-bg-dark);border-bottom:1px solid var(--border-color-dark)}.chat-header h1{color:var(--text-color-light);font-size:1.2rem;margin:0;transition:color .3s ease}body.dark-theme .chat-header h1{color:var(--text-color-dark)}.header-buttons{display:flex;gap:10px}.header-btn{background:0 0;border:none;cursor:pointer;font-size:1.2rem;color:#8a8d91;transition:color .2s ease}.header-btn:hover{color:var(--user-bubble-light)}#message-container{flex-grow:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;gap:15px}.message{display:flex;flex-direction:column;max-width:75%;animation:fadeIn .5s ease-out}.message .bubble{padding:10px 15px;border-radius:18px;line-height:1.5;word-wrap:break-word}.message .timestamp{font-size:.75rem;color:#8a8d91;margin-top:5px;padding:0 5px}.user-message{align-self:flex-end}.user-message .bubble{background:var(--user-bubble-light);color:var(--text-user-light);border-bottom-right-radius:4px}.user-message .timestamp{text-align:right}.bot-message{align-self:flex-start}.bot-message .bubble{background:var(--bot-bubble-light);color:var(--text-bot-light);border-bottom-left-radius:4px}body.dark-theme .bot-message .bubble{background:var(--bot-bubble-dark);color:var(--text-bot-dark)}.bot-message .timestamp{text-align:left}.typing-indicator .dot{width:8px;height:8px;background-color:#b0b3b8;border-radius:50%;animation:typing 1.4s infinite}.typing-indicator{display:flex;align-items:center;gap:5px}.typing-indicator .dot:nth-child(2){animation-delay:.2s}.typing-indicator .dot:nth-child(3){animation-delay:.4s}.chat-input-area{padding:15px 20px;border-top:1px solid var(--border-color-light)}body.dark-theme .chat-input-area{border-top:1px solid var(--border-color-dark)}#chat-form{display:flex;gap:10px}#user-input{flex-grow:1;border:none;background:var(--input-bg-light);border-radius:18px;padding:12px 18px;font-size:1rem;color:var(--text-color-light);transition:background-color .3s ease,color .3s ease}#user-input:focus{outline:0}body.dark-theme #user-input{background:var(--input-bg-dark);color:var(--text-color-dark)}#send-btn{background:var(--user-bubble-light);border:none;border-radius:50%;width:44px;height:44px;display:flex;justify-content:center;align-items:center;cursor:pointer;transition:transform .2s ease}#send-btn:hover{transform:scale(1.1)}#send-btn svg{fill:#fff}#debug-panel{position:fixed;bottom:20px;right:20px;width:350px;max-height:50vh;background:var(--debug-bg-light);color:var(--text-color-light);border:1px solid var(--border-color-light);border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:1000;display:flex;flex-direction:column;transition:all .3s ease}body.dark-theme #debug-panel{background:var(--debug-bg-dark);color:var(--text-color-dark);border-color:var(--border-color-dark)}#debug-panel.hidden{transform:translateY(20px);opacity:0;pointer-events:none}.debug-header{padding:8px 12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color-light);cursor:move}body.dark-theme .debug-header{border-color:var(--border-color-dark)}.debug-header h3{margin:0;font-size:.9rem}#debug-content{padding:10px;overflow-y:auto;font-size:.8rem}#debug-content pre{margin:5px 0;white-space:pre-wrap;word-wrap:break-word}@keyframes fadeIn{0%{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}@keyframes typing{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-5px)}}@media (max-width:768px){#chat-container{max-height:100vh;border-radius:0}}
    </style>
</head>
<body>
    <div id="chat-container">
        <header class="chat-header">
            <h1>Lindy AI Chat (con Memoria)</h1>
            <div class="header-buttons">
                <button id="clear-chat-btn" class="header-btn" title="Limpiar Chat y Memoria">üóëÔ∏è</button>
                <button id="theme-toggle-btn" class="header-btn" title="Cambiar Tema">üåô</button>
                <button id="debug-toggle-btn" class="header-btn" title="Depuraci√≥n">üêû</button>
            </div>
        </header>
        <main id="message-container"></main>
        <footer class="chat-input-area">
            <form id="chat-form">
                <input type="text" id="user-input" placeholder="Escribe tu mensaje..." autocomplete="off">
                <button type="submit" id="send-btn" title="Enviar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </form>
        </footer>
    </div>
    <div id="debug-panel" class="hidden">
        <div class="debug-header"><h3>Panel de Depuraci√≥n</h3><button id="close-debug-btn" class="header-btn">&times;</button></div>
        <div id="debug-content"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURACI√ìN FINAL ---
            const YOUR_SERVER_URL = 'https://lindy-chatbot-backend.vercel.app/api';

            // --- SELECTORES DOM ---
            const chatForm = document.getElementById('chat-form');
            const userInput = document.getElementById('user-input');
            const messageContainer = document.getElementById('message-container');
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            const clearChatBtn = document.getElementById('clear-chat-btn');
            const debugToggleBtn = document.getElementById('debug-toggle-btn');
            const debugPanel = document.getElementById('debug-panel');
            const closeDebugBtn = document.getElementById('close-debug-btn');
            const debugContent = document.getElementById('debug-content');

            // ‚úÖ NUEVO: Variable para almacenar el ID de la conversaci√≥n actual.
            let currentConversationId = null;

            // --- MANEJO DE EVENTOS ---
            chatForm.addEventListener('submit', handleSendMessage);
            themeToggleBtn.addEventListener('click', toggleTheme);
            clearChatBtn.addEventListener('click', clearChat);
            debugToggleBtn.addEventListener('click', () => debugPanel.classList.toggle('hidden'));
            closeDebugBtn.addEventListener('click', () => debugPanel.classList.add('hidden'));
            
            loadInitialState();

            // --- FUNCIONES PRINCIPALES ---

            async function handleSendMessage(event) {
                event.preventDefault();
                const messageText = userInput.value.trim();
                if (!messageText) return;

                addMessageToUI('user', messageText);
                saveChatSession(); // Guardamos inmediatamente despu√©s de enviar
                userInput.value = '';
                showTypingIndicator();

                try {
                    // ‚úÖ CAMBIO: Pasamos el ID de la conversaci√≥n actual a la funci√≥n fetch.
                    const fullResponseObject = await fetchAIResponse(messageText, currentConversationId);
                    
                    removeTypingIndicator();

                    // Extraemos el texto visible para el usuario de la respuesta.
                    const responseText = extractTextFromResponse(fullResponseObject);
                    addMessageToUI('bot', responseText);

                    // ‚úÖ CAMBIO: Actualizamos el ID de la conversaci√≥n si la respuesta contiene uno.
                    // Usamos el operador `||` para mantener el ID antiguo si no llega uno nuevo.
                    currentConversationId = fullResponseObject.data?.conversationId || currentConversationId;
                    
                    saveChatSession(); // Guardamos de nuevo con la respuesta y el posible nuevo ID.
                } catch (error) {
                    removeTypingIndicator();
                    const errorMessage = "Lo siento, hubo un error. Revisa el panel de depuraci√≥n para m√°s detalles.";
                    addMessageToUI('bot', errorMessage, 'error');
                    logToDebugPanel('Error en la Petici√≥n', error.toString());
                }
            }
            
            /**
             * ‚úÖ CAMBIO: Ahora acepta el `conversationId` y lo incluye en la petici√≥n al servidor.
             */
            async function fetchAIResponse(message, conversationId) {
                const requestId = Date.now().toString() + Math.random().toString(36).substring(2);
                
                const response = await fetch(YOUR_SERVER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: message, 
                        requestId: requestId, 
                        conversationId: conversationId // Se env√≠a el ID actual (puede ser null)
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ response: 'Error de red o respuesta no v√°lida del servidor.' }));
                    throw new Error(errorData.response || `Error del servidor: ${response.status}`);
                }
                
                // Devolvemos el objeto JSON completo para poder extraer el texto y el ID.
                return await response.json();
            }

            /**
             * ‚úÖ NUEVO: Funci√≥n para extraer el texto de la respuesta de forma segura.
             */
            function extractTextFromResponse(data) {
                logToDebugPanel('Respuesta Completa (v√≠a Servidor)', JSON.stringify(data, null, 2));

                if (typeof data === 'string') return data;
                if (data && data.response) return data.response;
                if (data && data.text) return data.text;
                if (data && data.message) return data.message;
                if (data && data.content) return data.content;
                // Si la respuesta es un objeto pero no tiene un campo de texto conocido, lo mostramos como JSON.
                if (data) return JSON.stringify(data, null, 2);

                return "No se recibi√≥ una respuesta legible del asistente.";
            }

            // --- FUNCIONES DE LA INTERFAZ Y ESTADO ---

            function addMessageToUI(sender, text, type = 'normal') {
                const messageDiv = document.createElement("div");
                messageDiv.className = `message ${sender}-message`;
                const bubble = document.createElement("div");
                bubble.className = "bubble";
                bubble.textContent = text;
                if (type === 'error') bubble.style.color = 'red';
                const timestamp = document.createElement("div");
                timestamp.className = "timestamp";
                timestamp.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                messageDiv.appendChild(bubble);
                messageDiv.appendChild(timestamp);
                messageContainer.appendChild(messageDiv);
                scrollToBottom();
            }

            function showTypingIndicator() {
                const indicatorDiv = document.createElement("div");
                indicatorDiv.className = "message bot-message";
                indicatorDiv.id = "typing-indicator";
                indicatorDiv.innerHTML = `<div class="bubble typing-indicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`;
                messageContainer.appendChild(indicatorDiv);
                scrollToBottom();
            }

            function removeTypingIndicator() {
                const indicator = document.getElementById("typing-indicator");
                if (indicator) indicator.remove();
            }

            function scrollToBottom() {
                messageContainer.scrollTop = messageContainer.scrollHeight;
            }

            function toggleTheme() {
                document.body.classList.toggle('dark-theme');
                const isDark = document.body.classList.contains('dark-theme');
                themeToggleBtn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
                localStorage.setItem('chat-theme', isDark ? 'dark' : 'light');
            }

            /**
             * ‚úÖ CAMBIO: Ahora tambi√©n resetea la memoria de la conversaci√≥n.
             */
            function clearChat() {
                messageContainer.innerHTML = '';
                currentConversationId = null; // Borramos la memoria
                localStorage.removeItem('chat-session'); // Borramos la sesi√≥n guardada
                addMessageToUI('bot', 'Hola, he olvidado nuestra conversaci√≥n anterior. ¬øEn qu√© puedo ayudarte hoy?');
            }

            /**
             * ‚úÖ CAMBIO: Guarda tanto el historial como el ID de la conversaci√≥n.
             */
            function saveChatSession() {
                const sessionData = {
                    history: messageContainer.innerHTML,
                    conversationId: currentConversationId
                };
                localStorage.setItem('chat-session', JSON.stringify(sessionData));
            }

            /**
             * ‚úÖ CAMBIO: Carga la sesi√≥n completa, incluyendo el ID de la conversaci√≥n.
             */
            function loadInitialState() {
                // Cargar tema
                const savedTheme = localStorage.getItem('chat-theme');
                if (savedTheme === 'dark') {
                    document.body.classList.add('dark-theme');
                    themeToggleBtn.textContent = '‚òÄÔ∏è';
                }

                // Cargar sesi√≥n de chat
                const savedSession = localStorage.getItem('chat-session');
                if (savedSession) {
                    const sessionData = JSON.parse(savedSession);
                    messageContainer.innerHTML = sessionData.history;
                    currentConversationId = sessionData.conversationId;
                    scrollToBottom();
                } else {
                    addMessageToUI('bot', 'Hola, ¬øen qu√© puedo ayudarte hoy?');
                }
            }
            
            function logToDebugPanel(title, content) {
                const entry = document.createElement("div");
                entry.innerHTML = `<strong>${title}:</strong><pre>${content}</pre>`;
                debugContent.appendChild(entry);
                debugContent.scrollTop = debugContent.scrollHeight;
            }
        });
    </script>
</body>
</html>
